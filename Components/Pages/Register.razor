@page "/register"
@inject Services.UserServices UserService
@inject NavigationManager NavigationManager
@using MyPocketTrack.Components.Modals
@using MudBlazor

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-16">
    <MudPaper Class="pa-8" Style="background: linear-gradient(135deg, #1976d2 0%, #64b5f6 100%);">
        <MudGrid>
            <MudItem xs="12">
                <div class="d-flex flex-column align-center mb-8">
                    <MudIcon Icon="@Icons.Material.Filled.PersonAdd" 
                            Color="Color.Surface" 
                            Size="Size.Large" 
                            Class="mb-4" />
                    <MudText Typo="Typo.h4" Color="Color.Surface" Class="text-center">Create Account</MudText>
                </div>

                <MudPaper Class="pa-8" Elevation="0">
                    <EditForm Model="@registerModel" OnValidSubmit="HandleRegistration">
                        <DataAnnotationsValidator />
                        
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-4">
                                @errorMessage
                            </MudAlert>
                        }

                        <MudTextField @bind-Value="registerModel.Username"
                                    Label="Username"
                                    Variant="Variant.Outlined"
                                    Class="mb-4" />

                        <MudTextField @bind-Value="registerModel.Password"
                                    Label="Password"
                                    Variant="Variant.Outlined"
                                    InputType="InputType.Password"
                                    Class="mb-4" />

                        <MudSelect @bind-Value="registerModel.CurrencyType"
                                 Label="Currency Type"
                                 Variant="Variant.Outlined"
                                 Class="mb-6"
                                 AnchorOrigin="Origin.BottomCenter">
                            <MudSelectItem Value="@("USD")">USD ($)</MudSelectItem>
                            <MudSelectItem Value="@("EUR")">EUR (€)</MudSelectItem>
                            <MudSelectItem Value="@("GBP")">GBP (£)</MudSelectItem>
                            <MudSelectItem Value="@("JPY")">JPY (¥)</MudSelectItem>
                            <MudSelectItem Value="@("INR")">INR (₹)</MudSelectItem>
                            <MudSelectItem Value="@("NEP")">NEP (Rs.)</MudSelectItem>
                        </MudSelect>

                        <MudButton ButtonType="ButtonType.Submit"
                                 Variant="Variant.Filled"
                                 Color="Color.Primary"
                                 FullWidth="true"
                                 Size="Size.Large"
                                 Class="mb-4">
                            Register
                        </MudButton>
                    </EditForm>

                    <MudDivider Class="my-4" />

                    <MudText Align="Align.Center">
                        Already have an account?
                        <MudLink Href="/login" Color="Color.Primary" Class="ml-2">Login here</MudLink>
                    </MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudPaper>
</MudContainer>

@code {
    private User registerModel = new User();
    private string? errorMessage;

    private async Task HandleRegistration()
    {
        try
        {
            errorMessage = string.Empty;
            if (string.IsNullOrWhiteSpace(registerModel.CurrencyType))
            {
                errorMessage = "Please select a currency type.";
                return;
            }

            var success = await UserService.RegisterUserAsync(registerModel);
            if (success)
            {
                NavigationManager.NavigateTo("/login");
            }
            else
            {
                errorMessage = "Username already exists. Please choose a different username.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "An error occurred during registration. Please try again.";
        }
    }
}